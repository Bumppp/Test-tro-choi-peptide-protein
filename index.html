<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán t·∫≠p: Peptide & Protein (v·ªõi AI)</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- D3.js for line drawing in Activity 2 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .chem-bg {
            background-color: #f0f4f8;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23dbeafe' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .tab-active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .tab-inactive {
            border-bottom-color: transparent;
            color: #6b7280;
        }
        .tab-locked {
            color: #9ca3af;
            cursor: not-allowed;
        }
        .tube-content {
            transition: all 0.5s ease-in-out;
        }
        .coagulated {
            background-image: radial-gradient(circle, #ffffff 20%, transparent 21%),
                              radial-gradient(circle, #ffffff 20%, transparent 21%);
            background-size: 15px 15px;
            background-position: 0 0, 7.5px 7.5px;
            animation: coagulate-anim 1s forwards;
        }
        @keyframes coagulate-anim {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .matching-card.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            transform: scale(1.05);
        }
        .whitespace-pre-wrap {
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // IMPORTANT: These variables are provided by the Canvas environment.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'peptide-protein-app-vn';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Authenticate user
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User is signed in with UID:", user.uid);
                window.renderApp(db, auth);
            } else {
                console.log("User is signed out. Attempting to sign in.");
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    signInWithCustomToken(auth, __initial_auth_token).catch(error => {
                        console.error("Error signing in with custom token:", error);
                        signInAnonymously(auth); // Fallback to anonymous
                    });
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Error signing in anonymously:", error);
                    });
                }
            }
        });

        window.db = db;
        window.firebase = { firestore: { getFirestore, collection, query, onSnapshot, orderBy, addDoc, serverTimestamp } };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        
        // --- Constants & Initial Data ---
        const ACTIVITY_1_ID = 'activity1';
        const ACTIVITY_2_ID = 'activity2';
        const ACTIVITY_3_ID = 'activity3';

        const initialTubes = {
            gly_ala: { id: 'gly_ala', name: 'Gly-Ala', correctRack: 'dipeptide', position: null, color: 'bg-blue-200', coagulated: false, reaction: 'Kh√¥ng hi·ªán t∆∞·ª£ng' },
            gly_ala_val: { id: 'gly_ala_val', name: 'Gly-Ala-Val', correctRack: 'tripeptide', position: null, color: 'bg-blue-200', coagulated: false, biuret: true, reaction: 'Ch∆∞a th·ª≠' },
            albumin: { id: 'albumin', name: 'L√≤ng tr·∫Øng tr·ª©ng', correctRack: 'protein', position: null, color: 'bg-yellow-100', coagulated: false, biuret: true, heat: true, reaction: 'Ch∆∞a th·ª≠' },
        };

        const racks = [
            { id: 'dipeptide', label: 'Dipeptide' },
            { id: 'tripeptide', label: 'Tripeptide (Ph·∫£n ·ª©ng Biuret)' },
            { id: 'protein', label: 'Protein (Ph·∫£n ·ª©ng Biuret & ƒê√¥ng t·ª•)' },
        ];
        
        const matchingItems = {
            colA: [
                { id: 'a1', content: 'Li√™n k·∫øt peptide', pair: 'b2' },
                { id: 'a2', content: 'Ph·∫£n ·ª©ng m√†u biuret', pair: 'b3' },
                { id: 'a3', content: 'Peptide', pair: 'b1' },
                { id: 'a4', content: 'Enzyme', pair: 'b5' },
                { id: 'a5', content: 'Th·ªßy ph√¢n ho√†n to√†n Protein', pair: 'b6' },
                { id: 'a6', content: 'S·ª± ƒë√¥ng t·ª• Protein', pair: 'b4' },
            ],
            colB: [
                { id: 'b1', content: 'ƒê∆∞·ª£c t·∫°o th√†nh t·ª´ c√°c ƒë∆°n v·ªã Œ±-amino acid.', pair: 'a3' },
                { id: 'b2', content: 'Li√™n k·∫øt c·ªßa nh√≥m -CO- v·ªõi nh√≥m -NH- gi·ªØa hai ƒë∆°n v·ªã Œ±-amino acid.', pair: 'a1' },
                { id: 'b3', content: 'C·∫ßn c√≥ t·ª´ hai li√™n k·∫øt peptide tr·ªü l√™n ƒë·ªÉ cho k·∫øt qu·∫£ d∆∞∆°ng t√≠nh (m√†u t√≠m).', pair: 'a2' },
                { id: 'b4', content: 'B·ªã bi·∫øn ƒë·ªïi c·∫•u tr√∫c khi ƒëun n√≥ng ho·∫∑c t√°c d·ª•ng v·ªõi acid, base.', pair: 'a6' },
                { id: 'b5', content: 'L√† ch·∫•t x√∫c t√°c sinh h·ªçc, h·∫ßu h·∫øt c√≥ b·∫£n ch·∫•t l√† protein.', pair: 'a4' },
                { id: 'b6', content: 'S·∫£n ph·∫©m cu·ªëi c√πng thu ƒë∆∞·ª£c l√† c√°c Œ±-amino acid.', pair: 'a5' },
            ]
        };

        const quizQuestions = [
            {
                question: "S·ªë li√™n k·∫øt peptide trong ph√¢n t·ª≠ peptide Gly-Ala-Val-Gly l√† bao nhi√™u?",
                options: ["2", "4", "3", "1"],
                answer: "3",
                explanation: "Peptide n√†y ƒë∆∞·ª£c t·∫°o t·ª´ 4 g·ªëc Œ±-amino acid n√™n s·∫Ω c√≥ (4-1) = 3 li√™n k·∫øt peptide."
            },
            {
                question: "Khi th·ªßy ph√¢n ho√†n to√†n protein ƒë∆°n gi·∫£n, s·∫£n ph·∫©m thu ƒë∆∞·ª£c l√†:",
                options: ["Polypeptide", "C√°c Œ±-amino acid", "Amino acid", "Dipeptide"],
                answer: "C√°c Œ±-amino acid",
                explanation: "Protein ƒë∆°n gi·∫£n ƒë∆∞·ª£c c·∫•u th√†nh t·ª´ c√°c Œ±-amino acid, do ƒë√≥ khi th·ªßy ph√¢n ho√†n to√†n s·∫Ω thu l·∫°i c√°c Œ±-amino acid."
            },
            {
                question: "C√≥ th·ªÉ d√πng thu·ªëc th·ª≠ n√†o sau ƒë√¢y ƒë·ªÉ ph√¢n bi·ªát dung d·ªãch Gly-Ala v√† dung d·ªãch Gly-Ala-Gly?",
                options: ["Dung d·ªãch HCl", "Dung d·ªãch NaOH", "Cu(OH)2 trong m√¥i tr∆∞·ªùng ki·ªÅm", "Qu·ª≥ t√≠m"],
                answer: "Cu(OH)2 trong m√¥i tr∆∞·ªùng ki·ªÅm",
                explanation: "Gly-Ala l√† dipeptide (c√≥ 1 li√™n k·∫øt peptide) kh√¥ng c√≥ ph·∫£n ·ª©ng m√†u biuret. Gly-Ala-Gly l√† tripeptide (c√≥ 2 li√™n k·∫øt peptide) n√™n c√≥ ph·∫£n ·ª©ng m√†u biuret t·∫°o dung d·ªãch m√†u t√≠m."
            },
            {
                question: "Ph√°t bi·ªÉu n√†o sau ƒë√¢y l√† sai?",
                options: [
                    "Dung d·ªãch protein c√≥ ph·∫£n ·ª©ng m√†u biuret.",
                    "Protein b·ªã th·ªßy ph√¢n nh·ªù x√∫c t√°c acid ho·∫∑c enzyme.",
                    "Anilin t√°c d·ª•ng v·ªõi n∆∞·ªõc brom t·∫°o k·∫øt t·ªßa tr·∫Øng.",
                    "T·∫•t c·∫£ c√°c protein ƒë·ªÅu tan trong n∆∞·ªõc t·∫°o th√†nh dung d·ªãch keo."
                ],
                answer: "T·∫•t c·∫£ c√°c protein ƒë·ªÅu tan trong n∆∞·ªõc t·∫°o th√†nh dung d·ªãch keo.",
                explanation: "Ch·ªâ c√≥ c√°c protein d·∫°ng h√¨nh c·∫ßu (nh∆∞ albumin) m·ªõi tan trong n∆∞·ªõc t·∫°o dung d·ªãch keo. C√°c protein d·∫°ng s·ª£i (nh∆∞ keratin trong t√≥c, m√≥ng) kh√¥ng tan trong n∆∞·ªõc."
            },
            {
                question: "Th·ªßy ph√¢n kh√¥ng ho√†n to√†n tetrapeptide (X) m·∫°ch h·ªü, thu ƒë∆∞·ª£c c√°c dipeptide l√† Gly-Ala, Ala-Phe v√† tripeptide l√† Gly-Ala-Phe. C·∫•u tr√∫c c·ªßa (X) l√†:",
                options: ["Gly-Ala-Phe-Val", "Val-Phe-Gly-Ala", "Ala-Phe-Val-Gly", "Gly-Ala-Val-Phe"],
                answer: "Gly-Ala-Phe-Val",
                explanation: "D·ª±a v√†o c√°c s·∫£n ph·∫©m th·ªßy ph√¢n, ta c√≥ th·ªÉ gh√©p n·ªëi: Gly-Ala v√† Ala-Phe cho th·∫•y tr√¨nh t·ª± l√† Gly-Ala-Phe. V√¨ X l√† tetrapeptide, amino acid cu·ªëi c√πng ph·∫£i l√† Val ƒë·ªÉ t·∫°o th√†nh Gly-Ala-Phe-Val."
            },
            {
                question: "Trong d√¢n gian, ng∆∞·ªùi ta th∆∞·ªùng d√πng n∆∞·ªõc √©p d·ª©a ho·∫∑c ƒëu ƒë·ªß ƒë·ªÉ ∆∞·ªõp th·ªãt tr∆∞·ªõc khi n·∫•u. Vi·ªác l√†m n√†y c√≥ t√°c d·ª•ng g√¨?",
                options: [
                    "L√†m th·ªãt c√≥ v·ªã ng·ªçt h∆°n.",
                    "Th√™m vitamin cho m√≥n ƒÉn.",
                    "Kh·ª≠ m√πi tanh c·ªßa th·ªãt.",
                    "Gi√∫p th·ªãt nhanh m·ªÅm h∆°n do th·ªßy ph√¢n protein."
                ],
                answer: "Gi√∫p th·ªãt nhanh m·ªÅm h∆°n do th·ªßy ph√¢n protein.",
                explanation: "Trong d·ª©a v√† ƒëu ƒë·ªß c√≥ ch·ª©a c√°c enzyme nh∆∞ bromelain v√† papain, ch√∫ng c√≥ kh·∫£ nƒÉng th·ªßy ph√¢n protein trong th·ªãt, l√†m cho c√°c s·ª£i c∆° ng·∫Øn l·∫°i v√† th·ªãt s·∫Ω m·ªÅm h∆°n khi n·∫•u."
            }
        ];

        // --- Gemini API Helper ---
        const callGemini = async (prompt) => {
            const apiKey = ""; // This will be handled by the execution environment.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    return `L·ªói t·ª´ API: ${errorBody.error?.message || 'Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt.'}`;
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                     if (result.promptFeedback?.blockReason) {
                         return `Y√™u c·∫ßu c·ªßa b·∫°n ƒë√£ b·ªã ch·∫∑n v√¨: ${result.promptFeedback.blockReason}. Vui l√≤ng th·ª≠ l·∫°i v·ªõi m·ªôt n·ªôi dung kh√°c.`;
                    }
                    console.error("Unexpected API response structure:", result);
                    return "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ AI.";
                }
            } catch (error) {
                console.error("Fetch error:", error);
                return "ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i.";
            }
        };

        // --- Helper Components ---
        const Icon = ({ path, className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d={path} />
            </svg>
        );

        const Modal = ({ children, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                <div className="bg-white rounded-lg shadow-xl p-6 m-4 max-w-sm w-full text-center relative">
                    <button onClick={onClose} className="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                        <Icon path="M6 18L18 6M6 6l12 12" />
                    </button>
                    {children}
                </div>
            </div>
        );

        // --- Activity 1: Magic Lab ---
        function Activity1({ onComplete, onRetry }) {
            const [tubes, setTubes] = useState(JSON.parse(JSON.stringify(initialTubes)));
            const [draggedItem, setDraggedItem] = useState(null);
            const [message, setMessage] = useState('');

            const handleDragStart = (e, item) => {
                setDraggedItem(item);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDropOnTube = (e, tubeId) => {
                e.preventDefault();
                if (!draggedItem || !draggedItem.isReagent) return;

                const tube = tubes[tubeId];
                setTubes(prev => {
                    const newTubes = { ...prev };
                    if (draggedItem.id === 'biuret' && tube.biuret) {
                        newTubes[tubeId].color = 'bg-purple-400';
                        newTubes[tubeId].reaction = 'H√≥a t√≠m';
                        setMessage(`·ªêng ${tube.name} chuy·ªÉn m√†u t√≠m!`);
                    } else if (draggedItem.id === 'heat' && tube.heat) {
                        newTubes[tubeId].coagulated = true;
                        newTubes[tubeId].reaction = 'ƒê√¥ng t·ª•';
                        setMessage(`·ªêng ${tube.name} b·ªã ƒë√¥ng t·ª•!`);
                    } else {
                        setMessage(`Kh√¥ng c√≥ ph·∫£n ·ª©ng x·∫£y ra v·ªõi ·ªëng ${tube.name}.`);
                    }
                    return newTubes;
                });
                setTimeout(() => setMessage(''), 2000);
            };

            const handleDropOnRack = (e, rackId) => {
                e.preventDefault();
                if (!draggedItem || draggedItem.isReagent) return;

                const tubeId = draggedItem.id;
                const tube = tubes[tubeId];
                if (tube.correctRack === rackId) {
                    setTubes(prev => ({ ...prev, [tubeId]: { ...prev[tubeId], position: rackId } }));
                    setMessage(`Ch√≠nh x√°c! ${tube.name} ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t ƒë√∫ng v·ªã tr√≠.`);
                } else {
                    setMessage(`Sai r·ªìi! V·ªã tr√≠ n√†y kh√¥ng ph√π h·ª£p v·ªõi ${tube.name}.`);
                }
                setTimeout(() => setMessage(''), 2000);
            };

            const handleDragOver = (e) => e.preventDefault();
            
            const placedTubesCount = Object.values(tubes).filter(t => t.position).length;
            const isComplete = placedTubesCount === 3; // UPDATED from 4 to 3

            useEffect(() => {
                if (isComplete) {
                    setMessage('Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh ph√≤ng th√≠ nghi·ªám!');
                    onComplete(ACTIVITY_1_ID, 100);
                }
            }, [isComplete, onComplete]);
            
            const handleLocalRetry = () => {
                setTubes(JSON.parse(JSON.stringify(initialTubes)));
                setMessage('');
                onRetry(ACTIVITY_1_ID);
            }

            return (
                <div className="p-4 md:p-6 bg-white/60 backdrop-blur-sm rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold text-gray-800 mb-2">Ho·∫°t ƒë·ªông 1: Ph√≤ng Th√≠ Nghi·ªám Di·ªáu K·ª≥ üß™</h3>
                    <p className="text-gray-600 mb-4">K√©o thu·ªëc th·ª≠ v√†o ·ªëng nghi·ªám ƒë·ªÉ quan s√°t ph·∫£n ·ª©ng, sau ƒë√≥ k√©o ·ªëng nghi·ªám v√†o ƒë√∫ng gi√° ƒë·ª°.</p>
                    
                    {message && <div className="p-3 mb-4 text-center text-sm font-semibold text-white bg-blue-500 rounded-lg shadow-md">{message}</div>}

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-1 space-y-6">
                            <div className="bg-white p-4 rounded-lg shadow">
                                <h4 className="font-semibold mb-2">Thu·ªëc th·ª≠</h4>
                                <div className="flex space-x-4">
                                    <div id="biuret" draggable onDragStart={(e) => handleDragStart(e, { id: 'biuret', isReagent: true })} className="cursor-grab p-2 text-center">
                                        <div className="w-16 h-16 mx-auto bg-cyan-500 rounded-full flex items-center justify-center text-white font-bold text-xs shadow-inner">Cu(OH)‚ÇÇ</div>
                                        <p className="text-sm mt-1">Biuret</p>
                                    </div>
                                    <div id="heat" draggable onDragStart={(e) => handleDragStart(e, { id: 'heat', isReagent: true })} className="cursor-grab p-2 text-center">
                                        <Icon path="M15.364 5.025A9.96 9.96 0 0112 3c-1.636 0-3.18.39-4.57.996M15 1.5l-1.5 3M9 1.5l1.5 3M12 21a9 9 0 110-18 9 9 0 010 18z" className="w-16 h-16 mx-auto text-red-500"/>
                                        <p className="text-sm mt-1">ƒêun n√≥ng</p>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow">
                                <h4 className="font-semibold mb-2">·ªêng nghi·ªám ch∆∞a ph√¢n lo·∫°i</h4>
                                <div className="flex flex-wrap justify-center gap-2">
                                    {Object.values(tubes).filter(t => !t.position).map(tube => (
                                        <div key={tube.id} draggable onDragStart={(e) => handleDragStart(e, tube)} onDrop={(e) => handleDropOnTube(e, tube.id)} onDragOver={handleDragOver} className="cursor-grab p-2 text-center">
                                            <div className="w-12 h-24 border-2 border-gray-400 rounded-b-lg rounded-t-sm relative mx-auto">
                                                <div className={`absolute bottom-0 left-0 right-0 h-3/4 rounded-b-md tube-content ${tube.color} ${tube.coagulated ? 'coagulated' : ''}`}></div>
                                            </div>
                                            <p className="text-xs mt-1">{tube.name}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                            <h4 className="font-semibold mb-4 text-center">Gi√° ƒë·ª°</h4>
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                {racks.map(rack => (
                                    <div key={rack.id} onDrop={(e) => handleDropOnRack(e, rack.id)} onDragOver={handleDragOver} className="bg-gray-200 p-3 rounded-lg min-h-[200px] flex flex-col items-center border-2 border-dashed border-gray-400">
                                        <h5 className="text-sm font-bold text-center mb-2">{rack.label}</h5>
                                        {Object.values(tubes).filter(t => t.position === rack.id).map(tube => (
                                            <div key={tube.id} className="p-2 text-center">
                                                <div className="w-12 h-24 border-2 border-gray-400 rounded-b-lg rounded-t-sm relative mx-auto">
                                                    <div className={`absolute bottom-0 left-0 right-0 h-3/4 rounded-b-md tube-content ${tube.color} ${tube.coagulated ? 'coagulated' : ''}`}></div>
                                                </div>
                                                <p className="text-xs mt-1">{tube.name}</p>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="mt-6 flex justify-end">
                        <button onClick={handleLocalRetry} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition">
                            L√†m l·∫°i
                        </button>
                    </div>
                </div>
            );
        }

        // --- Activity 2: Knowledge Puzzle ---
        function Activity2({ onComplete, onRetry }) {
            const [cards, setCards] = useState({
                colA: matchingItems.colA.map(c => ({...c, order: Math.random()})).sort((a, b) => a.order - b.order),
                colB: matchingItems.colB.map(c => ({...c, order: Math.random()})).sort((a, b) => a.order - b.order)
            });
            const [selected, setSelected] = useState(null);
            const [pairs, setPairs] = useState([]);
            const [message, setMessage] = useState('');
            const svgRef = useRef(null);
            const cardRefs = useRef({});

            const handleCardClick = (card, col) => {
                if (pairs.some(p => p.includes(card.id))) return;

                if (!selected) {
                    setSelected({ ...card, col });
                } else if (selected.col !== col) {
                    if (selected.pair === card.id) {
                        setPairs(prev => [...prev, [selected.id, card.id]]);
                        setMessage('Ch√≠nh x√°c!');
                    } else {
                        setMessage('Ch∆∞a ƒë√∫ng, h√£y th·ª≠ l·∫°i!');
                    }
                    setSelected(null);
                    setTimeout(() => setMessage(''), 1500);
                } else {
                    setSelected({ ...card, col });
                }
            };

            useEffect(() => {
                if (pairs.length === cards.colA.length) {
                    setMessage('Xu·∫•t s·∫Øc! B·∫°n ƒë√£ gh√©p ƒë√∫ng t·∫•t c·∫£ c√°c c·∫∑p.');
                    onComplete(ACTIVITY_2_ID, 100);
                }
            }, [pairs, cards.colA.length, onComplete]);
            
            useEffect(() => {
                const svg = d3.select(svgRef.current);
                svg.selectAll("*").remove();
                
                pairs.forEach(pair => {
                    const startNode = cardRefs.current[pair[0]];
                    const endNode = cardRefs.current[pair[1]];
                    if (startNode && endNode) {
                        const startPos = { x: startNode.offsetLeft + startNode.offsetWidth, y: startNode.offsetTop + startNode.offsetHeight / 2 };
                        const endPos = { x: endNode.offsetLeft, y: endNode.offsetTop + endNode.offsetHeight / 2 };
                        
                        svg.append("line")
                            .attr("x1", startPos.x)
                            .attr("y1", startPos.y)
                            .attr("x2", endPos.x)
                            .attr("y2", endPos.y)
                            .attr("stroke", "#22c55e")
                            .attr("stroke-width", 3);
                    }
                });
            }, [pairs, cards]);

            const handleLocalRetry = () => {
                setCards({
                    colA: matchingItems.colA.map(c => ({...c, order: Math.random()})).sort((a, b) => a.order - b.order),
                    colB: matchingItems.colB.map(c => ({...c, order: Math.random()})).sort((a, b) => a.order - b.order)
                });
                setSelected(null);
                setPairs([]);
                setMessage('');
                onRetry(ACTIVITY_2_ID);
            };

            return (
                <div className="p-4 md:p-6 bg-white/60 backdrop-blur-sm rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold text-gray-800 mb-2">Ho·∫°t ƒë·ªông 2: M·∫£nh Gh√©p Tri Th·ª©c üß©</h3>
                    <p className="text-gray-600 mb-4">N·ªëi c√°c th·∫ª ·ªü C·ªôt A v·ªõi c√°c th·∫ª m√¥ t·∫£ t∆∞∆°ng ·ª©ng ·ªü C·ªôt B.</p>
                    
                    {message && <div className={`p-3 mb-4 text-center text-sm font-semibold text-white ${message.includes('Ch√≠nh x√°c') || message.includes('Xu·∫•t s·∫Øc') ? 'bg-green-500' : 'bg-red-500'} rounded-lg shadow-md`}>{message}</div>}

                    <div className="relative">
                        <svg ref={svgRef} className="absolute top-0 left-0 w-full h-full pointer-events-none z-0"></svg>
                        <div className="grid grid-cols-2 gap-4 md:gap-8 relative z-10">
                            <div className="space-y-3">
                                {cards.colA.map(card => (
                                    <div key={card.id} ref={el => cardRefs.current[card.id] = el}
                                        onClick={() => handleCardClick(card, 'A')}
                                        className={`p-4 bg-white rounded-lg shadow-md border-2 transition-all cursor-pointer h-24 flex items-center justify-center text-center
                                            ${selected?.id === card.id ? 'matching-card selected' : 'border-transparent'}
                                            ${pairs.some(p => p.includes(card.id)) ? 'bg-green-100 border-green-300' : 'hover:border-blue-400'}`}>
                                        <p className="font-semibold text-gray-700">{card.content}</p>
                                    </div>
                                ))}
                            </div>
                            <div className="space-y-3">
                                {cards.colB.map(card => (
                                    <div key={card.id} ref={el => cardRefs.current[card.id] = el}
                                        onClick={() => handleCardClick(card, 'B')}
                                        className={`p-4 bg-white rounded-lg shadow-md border-2 transition-all cursor-pointer h-24 flex items-center justify-center text-center
                                            ${selected?.id === card.id ? 'matching-card selected' : 'border-transparent'}
                                            ${pairs.some(p => p.includes(card.id)) ? 'bg-green-100 border-green-300' : 'hover:border-blue-400'}`}>
                                        <p className="text-gray-600">{card.content}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    <div className="mt-6 flex justify-end">
                        <button onClick={handleLocalRetry} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition">
                            L√†m l·∫°i
                        </button>
                    </div>
                </div>
            );
        }

        // --- Activity 3: Conquer Knowledge ---
        function Activity3({ onComplete, onRetry }) {
            const [answers, setAnswers] = useState({});
            const [submitted, setSubmitted] = useState(false);
            const [aiExplanations, setAiExplanations] = useState({});

            const handleOptionChange = (qIndex, option) => {
                if (submitted) return;
                setAnswers(prev => ({ ...prev, [qIndex]: option }));
            };

            const handleSubmit = () => {
                setSubmitted(true);
                const score = quizQuestions.reduce((acc, q, i) => acc + (answers[i] === q.answer ? 1 : 0), 0);
                const percentage = (score / quizQuestions.length) * 100;
                onComplete(ACTIVITY_3_ID, percentage, answers);
            };
            
            const handleLocalRetry = () => {
                setAnswers({});
                setSubmitted(false);
                setAiExplanations({});
                onRetry(ACTIVITY_3_ID);
            };
            
            const handleGenerateExplanation = async (qIndex) => {
                const q = quizQuestions[qIndex];
                setAiExplanations(prev => ({ ...prev, [qIndex]: { loading: true, text: '' } }));

                const prompt = `V·ªõi vai tr√≤ l√† m·ªôt gia s∆∞ H√≥a h·ªçc, h√£y gi·∫£i th√≠ch s√¢u h∆°n v·ªÅ c√¢u h·ªèi v√† ƒë√°p √°n sau ƒë√¢y cho h·ªçc sinh l·ªõp 12 m·ªôt c√°ch d·ªÖ hi·ªÉu. T·∫≠p trung v√†o l√Ω do t·∫°i sao ƒë√°p √°n n√†y ƒë√∫ng v√† c√°c ƒë√°p √°n kh√°c sai. S·ª≠ d·ª•ng g·∫°ch ƒë·∫ßu d√≤ng ho·∫∑c ƒë·ªãnh d·∫°ng r√µ r√†ng.
                ---
                C√¢u h·ªèi: "${q.question}"
                ƒê√°p √°n ƒë√∫ng: "${q.answer}"
                Gi·∫£i th√≠ch g·ªëc: "${q.explanation}"
                ---
                H√£y cung c·∫•p m·ªôt l·ªùi gi·∫£i th√≠ch chi ti·∫øt v√† s√¢u s·∫Øc h∆°n.`;

                const result = await callGemini(prompt);
                setAiExplanations(prev => ({ ...prev, [qIndex]: { loading: false, text: result } }));
            };
            
            const score = useMemo(() => {
                if (!submitted) return 0;
                return quizQuestions.reduce((acc, q, i) => acc + (answers[i] === q.answer ? 1 : 0), 0);
            }, [submitted, answers]);

            return (
                <div className="p-4 md:p-6 bg-white/60 backdrop-blur-sm rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold text-gray-800 mb-2">Ho·∫°t ƒë·ªông 3: Chinh Ph·ª•c Ki·∫øn Th·ª©c üèÜ</h3>
                    <p className="text-gray-600 mb-4">Ch·ªçn ƒë√°p √°n ƒë√∫ng cho c√°c c√¢u h·ªèi sau.</p>
                    
                    <div className="space-y-6">
                        {quizQuestions.map((q, qIndex) => (
                            <div key={qIndex} className={`p-4 rounded-lg bg-white shadow-md transition-all ${submitted ? (answers[qIndex] === q.answer ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500') : ''}`}>
                                <p className="font-semibold mb-3">{`C√¢u ${qIndex + 1}: ${q.question}`}</p>
                                <div className="space-y-2">
                                    {q.options.map((option, oIndex) => {
                                        const isCorrect = q.answer === option;
                                        const isSelected = answers[qIndex] === option;
                                        let optionClass = "border-gray-300";
                                        if (submitted) {
                                            if (isCorrect) optionClass = "bg-green-100 border-green-400";
                                            else if (isSelected) optionClass = "bg-red-100 border-red-400";
                                        }
                                        return (
                                            <label key={oIndex} className={`flex items-center p-3 border rounded-lg cursor-pointer transition ${optionClass}`}>
                                                <input type="radio" name={`question-${qIndex}`} value={option} checked={isSelected} onChange={() => handleOptionChange(qIndex, option)} disabled={submitted} className="mr-3"/>
                                                <span>{option}</span>
                                            </label>
                                        );
                                    })}
                                </div>
                                {submitted && (
                                    <>
                                        <div className="mt-3 p-3 bg-gray-50 rounded-lg text-sm">
                                            <p><strong>ƒê√°p √°n ƒë√∫ng:</strong> {q.answer}</p>
                                            <p><strong>Gi·∫£i th√≠ch:</strong> {q.explanation}</p>
                                        </div>
                                        <div className="mt-2">
                                            {!aiExplanations[qIndex]?.text && !aiExplanations[qIndex]?.loading && (
                                                <button onClick={() => handleGenerateExplanation(qIndex)} className="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                                                    ‚ú® Gi·∫£i th√≠ch s√¢u h∆°n v·ªõi AI
                                                </button>
                                            )}
                                            {aiExplanations[qIndex]?.loading && <p className="text-sm text-gray-500 animate-pulse">AI ƒëang so·∫°n gi·∫£i th√≠ch...</p>}
                                            {aiExplanations[qIndex]?.text && (
                                                <div className="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-gray-800 whitespace-pre-wrap">
                                                    <h4 className="font-bold mb-1 text-blue-700">‚ú® Gi·∫£i th√≠ch t·ª´ AI:</h4>
                                                    {aiExplanations[qIndex].text}
                                                </div>
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>
                        ))}
                    </div>

                    <div className="mt-6 flex justify-between items-center">
                        <button onClick={handleLocalRetry} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition">
                            L√†m l·∫°i
                        </button>
                        {!submitted ? (
                            <button onClick={handleSubmit} disabled={Object.keys(answers).length !== quizQuestions.length} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition disabled:bg-gray-400">
                                N·ªôp b√†i
                            </button>
                        ) : (
                            <div className="text-lg font-bold text-blue-600">
                                ƒêi·ªÉm c·ªßa b·∫°n: {score} / {quizQuestions.length}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- Main Pages ---
        function LoginPage({ onLogin }) {
            const [name, setName] = useState('');
            const [className, setClassName] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (name.trim() && className.trim()) {
                    onLogin({ name: name.trim(), className: className.trim() });
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center chem-bg p-4">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 space-y-6">
                        <div className="text-center">
                             <svg className="mx-auto h-12 w-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor">
                                <path d="M14.25 6.087c0-.66.537-1.197 1.197-1.197h.006c.66 0 1.197.537 1.197 1.197v7.626c0 .66-.537 1.197-1.197 1.197h-.006a1.197 1.197 0 01-1.197-1.197V6.087zM6.75 12h.008v.008H6.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM4.5 9.75v-.008h-.008V9.75h.008zm0-.375a.375.375 0 11-.75 0 .375.375 0 01.75 0zM12 3.75v.008h.008V3.75H12zm0-.375a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                                <path d="M6.828 12.75h7.344a2.25 2.25 0 012.25 2.25v1.5a2.25 2.25 0 002.25 2.25h.01a2.25 2.25 0 002.25-2.25v-1.5a2.25 2.25 0 012.25-2.25h.008a2.25 2.25 0 012.25 2.25v1.5a2.25 2.25 0 002.25 2.25h.01a2.25 2.25 0 002.25-2.25v-1.5a2.25 2.25 0 012.25-2.25h.008a2.25 2.25 0 012.25 2.25v1.5a2.25 2.25 0 002.25 2.25h.01M15 18.75a.375.375 0 11-1.5 0 .375.375 0 011.5 0z" />
                            </svg>
                            <h1 className="text-3xl font-extrabold text-gray-800 mt-2">Luy·ªán t·∫≠p: Peptide & Protein</h1>
                            <p className="text-gray-500 mt-2">Nh·∫≠p th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label htmlFor="name" className="text-sm font-medium text-gray-700">H·ªç v√† t√™n</label>
                                <input id="name" type="text" value={name} onChange={e => setName(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label htmlFor="className" className="text-sm font-medium text-gray-700">L·ªõp</label>
                                <input id="className" type="text" value={className} onChange={e => setClassName(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <button type="submit" className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                                B·∫Øt ƒë·∫ßu
                            </button>
                        </form>
                        <p className="text-xs text-center text-gray-400">GV ƒëƒÉng nh·∫≠p v·ªõi H·ªç t√™n: 123456, L·ªõp: GV</p>
                    </div>
                </div>
            );
        }

        function PracticePage({ user, onCompleteAll, onLogout }) {
            const [activeTab, setActiveTab] = useState(ACTIVITY_1_ID);
            const [completion, setCompletion] = useState({ [ACTIVITY_1_ID]: false, [ACTIVITY_2_ID]: false, [ACTIVITY_3_ID]: false });
            const [scores, setScores] = useState({ [ACTIVITY_1_ID]: 0, [ACTIVITY_2_ID]: 0, [ACTIVITY_3_ID]: 0 });
            const [retries, setRetries] = useState({ [ACTIVITY_1_ID]: 0, [ACTIVITY_2_ID]: 0, [ACTIVITY_3_ID]: 0 });
            const [quizAnswers, setQuizAnswers] = useState(null);
            const [startTime] = useState(Date.now());
            const [unlockModal, setUnlockModal] = useState(null);

            const handleActivityComplete = useCallback((activityId, score, details) => {
                setCompletion(prev => ({ ...prev, [activityId]: true }));
                setScores(prev => ({ ...prev, [activityId]: score }));

                if (activityId === ACTIVITY_3_ID && details) {
                    setQuizAnswers(details);
                }

                let nextActivity = null;
                if (activityId === ACTIVITY_1_ID) nextActivity = ACTIVITY_2_ID;
                if (activityId === ACTIVITY_2_ID) nextActivity = ACTIVITY_3_ID;
                
                if (nextActivity) {
                    setUnlockModal({ title: `Ho·∫°t ƒë·ªông ${parseInt(nextActivity.slice(-1))} ƒë√£ ƒë∆∞·ª£c m·ªü kh√≥a!`, next: nextActivity });
                }
            }, []);
            
            const handleRetry = useCallback((activityId) => {
                setScores(prev => ({...prev, [activityId]: 0}));
                setRetries(prev => ({...prev, [activityId]: prev[activityId] + 1}));
                setCompletion(prev => ({...prev, [activityId]: false}));
                if(activityId === ACTIVITY_3_ID) {
                    setQuizAnswers(null);
                }
            }, []);

            const closeUnlockModal = () => {
                if (unlockModal) {
                    setActiveTab(unlockModal.next);
                }
                setUnlockModal(null);
            };

            const allComplete = Object.values(completion).every(Boolean);
            useEffect(() => {
                if (allComplete) {
                    const totalTime = Math.round((Date.now() - startTime) / 1000);
                    onCompleteAll({ scores, retries, totalTime, quizAnswers });
                }
            }, [allComplete, quizAnswers, onCompleteAll, scores, retries, startTime]);

            const tabs = [
                { id: ACTIVITY_1_ID, name: 'Hƒê 1: Ph√≤ng Th√≠ Nghi·ªám', locked: false },
                { id: ACTIVITY_2_ID, name: 'Hƒê 2: Gh√©p C·∫∑p', locked: !completion[ACTIVITY_1_ID] },
                { id: ACTIVITY_3_ID, name: 'Hƒê 3: Tr·∫Øc Nghi·ªám', locked: !completion[ACTIVITY_2_ID] },
            ];

            return (
                <div className="min-h-screen chem-bg p-4 sm:p-6 lg:p-8">
                    {unlockModal && (
                        <Modal onClose={closeUnlockModal}>
                            <div className="text-center">
                                <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                                    <Icon path="M4.5 12.75l6 6 9-13.5" className="h-6 w-6 text-green-600" />
                                </div>
                                <h3 className="text-lg leading-6 font-medium text-gray-900 mt-4">{unlockModal.title}</h3>
                                <div className="mt-2 px-7 py-3">
                                    <p className="text-sm text-gray-500">H√£y chuy·ªÉn sang ho·∫°t ƒë·ªông ti·∫øp theo ƒë·ªÉ chinh ph·ª•c th·ª≠ th√°ch m·ªõi.</p>
                                </div>
                                <div className="items-center px-4 py-3">
                                    <button onClick={closeUnlockModal} className="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                                        Ti·∫øp t·ª•c
                                    </button>
                                </div>
                            </div>
                        </Modal>
                    )}
                    <div className="max-w-7xl mx-auto">
                        <header className="flex justify-between items-center mb-6 p-4 bg-white/50 backdrop-blur-sm rounded-lg shadow">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-900">Ch√†o, {user.name}!</h1>
                                <p className="text-gray-600">L·ªõp: {user.className}</p>
                            </div>
                            <button onClick={onLogout} className="text-sm font-medium text-gray-500 hover:text-gray-700">ƒêƒÉng xu·∫•t</button>
                        </header>

                        <div className="border-b border-gray-200">
                            <nav className="-mb-px flex space-x-6" aria-label="Tabs">
                                {tabs.map(tab => (
                                    <button
                                        key={tab.name}
                                        onClick={() => !tab.locked && setActiveTab(tab.id)}
                                        className={`py-4 px-3 bg-white/50 rounded-t-lg transition-colors duration-200
                                            ${tab.locked ? 'tab-locked' : (activeTab === tab.id ? 'tab-active' : 'tab-inactive hover:border-gray-300 hover:text-gray-700')}
                                        `}
                                        disabled={tab.locked}
                                    >
                                        {tab.locked && <Icon path="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" className="inline-block w-4 h-4 mr-1"/>}
                                        {tab.name}
                                    </button>
                                ))}
                            </nav>
                        </div>

                        <div className="mt-0">
                            {activeTab === ACTIVITY_1_ID && <Activity1 onComplete={handleActivityComplete} onRetry={handleRetry} />}
                            {activeTab === ACTIVITY_2_ID && <Activity2 onComplete={handleActivityComplete} onRetry={handleRetry} />}
                            {activeTab === ACTIVITY_3_ID && <Activity3 onComplete={handleActivityComplete} onRetry={handleRetry} />}
                        </div>
                    </div>
                </div>
            );
        }
        
        function SummaryPage({ user, results, onRestart, onSave }) {
            const [studyPlan, setStudyPlan] = useState('');
            const [isLoadingPlan, setIsLoadingPlan] = useState(false);

            const totalScore = Object.values(results.scores).reduce((a, b) => a + b, 0);
            const averageScore = totalScore / 3;
            const totalActivityRetries = Object.values(results.retries).reduce((a, b) => a + b, 0);
            const totalQuizCorrect = Math.round(results.scores.activity3 / 100 * quizQuestions.length);
            
            const handleSave = () => {
                const finalData = {
                    name: user.name,
                    className: user.className,
                    score: parseFloat(averageScore.toFixed(2)),
                    correctAnswers: totalQuizCorrect,
                    totalTime: results.totalTime
                };
                onSave(finalData);
            };

            const handleGeneratePlan = async () => {
                setIsLoadingPlan(true);

                const incorrectQuestionsInfo = quizQuestions
                    .map((q, i) => ({ ...q, userAnswer: results.quizAnswers ? results.quizAnswers[i] : null }))
                    .filter(q => q.userAnswer && q.userAnswer !== q.answer);

                if (incorrectQuestionsInfo.length === 0) {
                    setStudyPlan("üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u h·ªèi tr·∫Øc nghi·ªám. Ki·∫øn th·ª©c c·ªßa b·∫°n v·ªÅ ph·∫ßn n√†y r·∫•t v·ªØng ch·∫Øc. H√£y ti·∫øp t·ª•c ph√°t huy nh√©!");
                    setIsLoadingPlan(false);
                    return;
                }

                const prompt = `V·ªõi vai tr√≤ l√† m·ªôt gia s∆∞ H√≥a h·ªçc t·∫≠n t√¢m, h√£y t·∫°o m·ªôt k·∫ø ho·∫°ch √¥n t·∫≠p c√° nh√¢n h√≥a cho m·ªôt h·ªçc sinh l·ªõp 12. H·ªçc sinh n√†y ƒë√£ tr·∫£ l·ªùi sai c√°c c√¢u h·ªèi sau:
                ---
                ${incorrectQuestionsInfo.map((q, i) => 
                    `C√¢u sai ${i + 1}:
                    - C√¢u h·ªèi: ${q.question}
                    - ƒê√°p √°n c·ªßa h·ªçc sinh: ${q.userAnswer}
                    - ƒê√°p √°n ƒë√∫ng: ${q.answer}`
                ).join('\n\n')}
                ---
                D·ª±a tr√™n nh·ªØng l·ªói sai n√†y, h√£y:
                1.  X√°c ƒë·ªãnh c√°c ch·ªß ƒë·ªÅ/kh√°i ni·ªám ch√≠nh m√† h·ªçc sinh ch∆∞a n·∫Øm v·ªØng.
                2.  ƒê∆∞a ra m·ªôt k·∫ø ho·∫°ch √¥n t·∫≠p ng·∫Øn g·ªçn, r√µ r√†ng theo t·ª´ng ch·ªß ƒë·ªÅ.
                3.  Trong m·ªói ch·ªß ƒë·ªÅ, gi·∫£i th√≠ch l·∫°i kh√°i ni·ªám c·ªët l√µi m·ªôt c√°ch ƒë∆°n gi·∫£n.
                4.  ƒê∆∞a ra 1-2 c√¢u h·ªèi v√≠ d·ª• t∆∞∆°ng t·ª± ƒë·ªÉ h·ªçc sinh t·ª± luy·ªán t·∫≠p.
                Tr√¨nh b√†y th·∫≠t th√¢n thi·ªán, kh√≠ch l·ªá v√† s·ª≠ d·ª•ng markdown ƒë·ªÉ ƒë·ªãnh d·∫°ng cho d·ªÖ ƒë·ªçc (g·∫°ch ƒë·∫ßu d√≤ng, in ƒë·∫≠m).`;

                const result = await callGemini(prompt);
                setStudyPlan(result);
                setIsLoadingPlan(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center chem-bg p-4">
                    <div className="w-full max-w-3xl bg-white rounded-2xl shadow-xl p-8">
                        <div className="text-center">
                            <h1 className="text-3xl font-extrabold text-gray-800">Ho√†n th√†nh!</h1>
                            <p className="text-gray-600 mt-2">Ch√∫c m·ª´ng {user.name}, b·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c ho·∫°t ƒë·ªông.</p>
                        </div>

                        <div className="mt-8 bg-gray-50 p-6 rounded-lg">
                            <h2 className="text-xl font-bold text-gray-700 mb-4">B·∫£ng t·ªïng k·∫øt k·∫øt qu·∫£</h2>
                            <div className="grid grid-cols-2 gap-4 text-gray-600">
                                <div className="p-4 bg-white rounded-lg shadow-sm"><p className="text-sm">ƒêi·ªÉm trung b√¨nh</p><p className="text-2xl font-bold text-blue-600">{averageScore.toFixed(2)}</p></div>
                                <div className="p-4 bg-white rounded-lg shadow-sm"><p className="text-sm">T·ªïng th·ªùi gian</p><p className="text-2xl font-bold text-blue-600">{results.totalTime} gi√¢y</p></div>
                                <div className="p-4 bg-white rounded-lg shadow-sm"><p className="text-sm">S·ªë c√¢u tr·∫Øc nghi·ªám ƒë√∫ng</p><p className="text-2xl font-bold text-blue-600">{totalQuizCorrect} / {quizQuestions.length}</p></div>
                                <div className="p-4 bg-white rounded-lg shadow-sm"><p className="text-sm">T·ªïng s·ªë l·∫ßn l√†m l·∫°i</p><p className="text-2xl font-bold text-blue-600">{totalActivityRetries + results.totalRetries}</p></div>
                            </div>
                        </div>
                        
                        <div className="mt-8 text-center">
                            <div>
                                {!studyPlan && !isLoadingPlan && (
                                    <button onClick={handleGeneratePlan} className="bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform hover:scale-105 flex items-center gap-2 mx-auto">
                                        ‚ú® T·∫°o k·∫ø ho·∫°ch √¥n t·∫≠p c√° nh√¢n
                                    </button>
                                )}
                                <p className="text-xs text-gray-500 mt-2">AI s·∫Ω ph√¢n t√≠ch k·∫øt qu·∫£ c√°c c√¢u b·∫°n ƒë√£ l√†m sai ƒë·ªÉ t·∫°o ra l·ªô tr√¨nh √¥n t·∫≠p ph√π h·ª£p nh·∫•t cho ri√™ng b·∫°n.</p>
                            </div>
                            {isLoadingPlan && <p className="text-center text-gray-600 animate-pulse">AI ƒëang x√¢y d·ª±ng k·∫ø ho·∫°ch √¥n t·∫≠p cho b·∫°n...</p>}
                            {studyPlan && (
                                <div className="mt-4 p-6 bg-blue-50 border border-blue-200 rounded-lg text-gray-800 whitespace-pre-wrap text-left">
                                    <h3 className="text-lg font-bold mb-2 text-blue-800">‚ú® K·∫ø ho·∫°ch √¥n t·∫≠p c·ªßa b·∫°n:</h3>
                                    <div dangerouslySetInnerHTML={{ __html: studyPlan.replace(/\n/g, '<br />').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\* (.*?)(<br \/>|$)/g, '<li>$1</li>') }} />
                                </div>
                            )}
                        </div>

                        <div className="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                            <button onClick={onRestart} className="w-full sm:w-auto flex justify-center py-3 px-6 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition">
                                L√†m l·∫°i t·ª´ ƒë·∫ßu
                            </button>
                            <button onClick={handleSave} className="w-full sm:w-auto flex justify-center py-3 px-6 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition">
                                Ho√†n th√†nh & L∆∞u k·∫øt qu·∫£
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        
        function TeacherPage({ onLogout }) {
            const [studentData, setStudentData] = useState([]);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!window.db) {
                    setError("K·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu th·∫•t b·∫°i.");
                    return;
                }
                const { getFirestore, collection, query, onSnapshot, orderBy } = window.firebase.firestore;
                
                const db = getFirestore();
                const q = query(collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'peptide-protein-app-vn'}/public/data/student_results`), orderBy("submittedAt", "desc"));

                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const data = [];
                    querySnapshot.forEach((doc) => {
                        const docData = doc.data();
                        data.push({ 
                            id: doc.id,
                            ...docData,
                            submittedAt: docData.submittedAt?.toDate ? docData.submittedAt.toDate().toLocaleString('vi-VN') : 'Kh√¥ng c√≥'
                        });
                    });
                    setStudentData(data);
                }, (err) => {
                    console.error("Error fetching data: ", err);
                    setError("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu c·ªßa h·ªçc sinh. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† c·∫•u h√¨nh Firebase.");
                });

                return () => unsubscribe();
            }, []);

            return (
                <div className="min-h-screen chem-bg p-4 sm:p-6 lg:p-8">
                    <div className="max-w-7xl mx-auto">
                        <header className="flex justify-between items-center mb-6 p-4 bg-white/50 backdrop-blur-sm rounded-lg shadow">
                            <h1 className="text-2xl font-bold text-gray-900">Trang gi√°o vi√™n</h1>
                            <button onClick={onLogout} className="text-sm font-medium text-blue-600 hover:text-blue-800">ƒêƒÉng xu·∫•t</button>
                        </header>
                        
                        {error && <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert"><p>{error}</p></div>}

                        <div className="bg-white rounded-lg shadow-md overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">H·ªç v√† t√™n</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L·ªõp</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ƒêi·ªÉm TB</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√¢u ƒë√∫ng</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Th·ªùi gian (gi√¢y)</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Th·ªùi gian n·ªôp</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {studentData.length > 0 ? studentData.map((data) => (
                                            <tr key={data.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{data.name}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{data.className}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{data.score}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{data.correctAnswers} / {quizQuestions.length}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{data.totalTime}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{data.submittedAt}</td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan="6" className="px-6 py-4 text-center text-sm text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o c·ªßa h·ªçc sinh.</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- App Component ---
        function App() {
            const [page, setPage] = useState('login'); // login, practice, summary, teacher
            const [user, setUser] = useState(null);
            const [results, setResults] = useState(null);
            const [saveMessage, setSaveMessage] = useState('');
            const [totalRetries, setTotalRetries] = useState(0);

            const handleLogin = (userInfo) => {
                if (userInfo.name === '123456' && userInfo.className === 'GV') {
                    setUser(userInfo);
                    setPage('teacher');
                } else {
                    setUser(userInfo);
                    setPage('practice');
                }
            };
            
            const handleLogout = useCallback(() => {
                setUser(null);
                setPage('login');
                setResults(null);
                setTotalRetries(0);
                setSaveMessage(''); // FIX: Clear save message on logout
            }, []);
            
            const handleRestart = useCallback(() => {
                setPage('practice');
                setResults(null);
                setTotalRetries(prev => prev + 1);
            }, []);

            const handleCompleteAll = useCallback((finalResults) => {
                setResults({...finalResults, totalRetries});
                setPage('summary');
            }, [totalRetries]);

            const handleSave = useCallback(async (dataToSave) => {
                if (!window.db) {
                    setSaveMessage('L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi c∆° s·ªü d·ªØ li·ªáu.');
                    setTimeout(() => setSaveMessage(''), 3000);
                    return;
                }
                
                const { getFirestore, collection, addDoc, serverTimestamp } = window.firebase.firestore;
                const db = getFirestore();
                
                try {
                    const docRef = await addDoc(collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'peptide-protein-app-vn'}/public/data/student_results`), {
                        ...dataToSave,
                        submittedAt: serverTimestamp()
                    });
                    console.log("Document written with ID: ", docRef.id);
                    setSaveMessage('K·∫øt qu·∫£ c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ tham gia.');
                } catch (e) {
                    console.error("Error adding document: ", e);
                    setSaveMessage('ƒê√£ c√≥ l·ªói x·∫£y ra khi l∆∞u k·∫øt qu·∫£. Vui l√≤ng th·ª≠ l·∫°i.');
                    setTimeout(() => setSaveMessage(''), 3000);
                }
            }, []);

            if (saveMessage) {
                return (
                    <Modal onClose={handleLogout}>
                        <div className="text-center">
                            <h3 className="text-lg font-medium text-gray-900">{saveMessage.includes('th√†nh c√¥ng') ? 'Th√†nh c√¥ng!' : 'L·ªói'}</h3>
                            <p className="mt-2 text-sm text-gray-600">{saveMessage}</p>
                            <button onClick={handleLogout} className="mt-4 w-full bg-blue-500 text-white py-2 px-4 rounded-lg">V·ªÅ trang ch√≠nh</button>
                        </div>
                    </Modal>
                );
            }

            switch (page) {
                case 'practice':
                    return <PracticePage user={user} onCompleteAll={handleCompleteAll} onLogout={handleLogout} />;
                case 'summary':
                    return <SummaryPage user={user} results={results} onRestart={handleRestart} onSave={handleSave} />;
                case 'teacher':
                    return <TeacherPage onLogout={handleLogout} />;
                case 'login':
                default:
                    return <LoginPage onLogin={handleLogin} />;
            }
        }

        // Render the app
        window.renderApp = () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        };
    </script>
</body>
</html>
